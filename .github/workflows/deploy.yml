name: Build to OCIR and Deploy to VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: n8n-deploy
  cancel-in-progress: true

jobs:
  build-and-push:
    name: Build and Push to OCIR
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to OCIR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.OCIR_REGISTRY_URL }}
          username: ${{ secrets.OCIR_TENANCY_NAMESPACE }}/Default/${{ secrets.OCIR_USERNAME }}
          password: ${{ secrets.OCIR_TOKEN }}

      - name: Build and push (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64/v8
          push: true
          tags: ${{ secrets.OCIR_REGISTRY_URL }}/${{ secrets.OCIR_TENANCY_NAMESPACE }}/n8n:latest

  deploy-to-prod:
    name: Deploy to Production VM
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Copy docker-compose to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          source: "docker-compose.yml"
          target: "~/n8n-workflow"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          N8N_HOST: ${{ secrets.N8N_HOST }}
          N8N_PORT: ${{ secrets.N8N_PORT }}
          N8N_PROTOCOL: ${{ secrets.N8N_PROTOCOL }}
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          GENERIC_TIMEZONE: ${{ secrets.GENERIC_TIMEZONE }}
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}
          N8N_BASIC_AUTH_USER: ${{ secrets.N8N_BASIC_AUTH_USER }}
          N8N_BASIC_AUTH_PASSWORD: ${{ secrets.N8N_BASIC_AUTH_PASSWORD }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script_stop: true
          envs: N8N_HOST,N8N_PORT,N8N_PROTOCOL,WEBHOOK_URL,GENERIC_TIMEZONE,N8N_ENCRYPTION_KEY,N8N_BASIC_AUTH_USER,N8N_BASIC_AUTH_PASSWORD
          script: |
            set -euo pipefail
            mkdir -p ~/n8n-workflow
            cd ~/n8n-workflow
            if [ ! -f docker-compose.yml ]; then
              echo "docker-compose.yml missing" >&2; exit 1
            fi
            echo "${{ secrets.OCIR_TOKEN }}" | docker login ${{ secrets.OCIR_REGISTRY_URL }} -u "${{ secrets.OCIR_TENANCY_NAMESPACE }}/Default/${{ secrets.OCIR_USERNAME }}" --password-stdin
            # Derive sane defaults when domain is not available
            PUBLIC_IP="${N8N_HOST:-}"
            if [ -z "$PUBLIC_IP" ]; then
              PUBLIC_IP="$(curl -fsS http://checkip.amazonaws.com || curl -fsS https://ifconfig.me || hostname -I | awk '{print $1}')"
            fi
            PROTO="${N8N_PROTOCOL:-http}"
            PORT="${N8N_PORT:-5678}"
            HOST="${N8N_HOST:-$PUBLIC_IP}"
            WEBHOOK="${WEBHOOK_URL:-$PROTO://$HOST:$PORT}"

            cat > .env << EOF
            N8N_IMAGE=${{ secrets.OCIR_REGISTRY_URL }}/${{ secrets.OCIR_TENANCY_NAMESPACE }}/n8n:latest
            N8N_HOST=$HOST
            N8N_PORT=$PORT
            N8N_PROTOCOL=$PROTO
            WEBHOOK_URL=$WEBHOOK
            GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-UTC}
            N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-}
            N8N_BASIC_AUTH_ACTIVE=true
            N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
            N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-change_me}
            N8N_DIAGNOSTICS_ENABLED=false
            N8N_TELEMETRY_ENABLED=false
            N8N_PERSONALIZATION_ENABLED=false
            NODE_ENV=production
            EOF
            docker compose pull
            docker compose up -d
            docker compose ps
            echo "n8n URL: $WEBHOOK"


